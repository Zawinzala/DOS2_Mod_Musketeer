Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_Musketeer_RifleEquipped((CHARACTERGUID)NULL_00000000-0000-0000-0000-000000000000,0);
//DB_Musketeer_Executioner_AmmoRefunded((CHARACTERGUID)_Player, 0);

// Reload is special exception and not included in the skill-database.
DB_Musketeer_Skillist("Projectile_Rifle_Snipe", -1);
DB_Musketeer_Skillist("Projectile_Unload", 0);
DB_Musketeer_Skillist("Target_Unload_Test", 0);
DB_Musketeer_Skillist("Target_Mark_Target", 0);
DB_Musketeer_Skillist("Projectile_Rend_The_Marked", -1);
DB_Musketeer_Skillist("Projectile_Buckshot", -2);
DB_Musketeer_Skillist("Projectile_Final_Act", -1);
DB_Musketeer_Skillist("Projectile_Tracking_Shot", -1);
DB_Musketeer_Skillist("Projectile_Rapidfire", -2);
DB_Musketeer_Skillist("Target_Musk_Flare_Test_Target", -1);
//DB_Musketeer_Skillist("Target_Unload_Test", 0);
DB_Musketeer_Skillist("Shout_Reload", 11);


KBSECTION
// Instead of tracking Equip-Events of the weapon, we track when a player gets the Passive-skill that is automatically learned when equipping a rifle.

// TEST STUFF, COMMENT OUT WHEN PLAYING NORMALLY
/*
IF
SkillAdded(_Player, "Shout_Musketeer_Passive", 0)
AND
CharacterGetEquippedWeapon(_Player, _Weapon)
THEN
DisplayText(_Player, "<font color='#00FF00' size='30'>Armed with pew pew</font>");
CharacterAddSkill(_Player, "Shout_Reload");
//CharacterRemoveSkill(_Player, "Target_Unload_Test");
//CharacterAddSkill(_Player, "Projectile_Unload");
CharacterAddSkill(_Player, "Projectile_Rifle_Snipe");
CharacterAddSkill(_Player, "Target_Mark_Target");
CharacterAddSkill(_Player, "Projectile_Rend_The_Marked");
//CharacterAddSkill(_Player, "Projectile_FlareStart");
CharacterAddSkill(_Player, "Target_Musk_Flare_Test_Target");
CharacterAddSkill(_Player, "Target_Unload_Test");
CharacterAddSkill(_Player, "Projectile_Buckshot");
CharacterAddSkill(_Player, "Projectile_Shoot_Flare");
CharacterAddSkill(_Player, "Projectile_Rapidfire");
CharacterAddSkill(_Player, "Projectile_Double_Up");
CharacterAddSkill(_Player, "Shout_Reload_Incendiary");
CharacterAddSkill(_Player, "Shout_Reload_Explosive");
CharacterAddSkill(_Player, "Shout_Reload_Freezing");
CharacterAddSkill(_Player, "Shout_Reload_Silver");
CharacterAddSkill(_Player, "Shout_Reload_Holy");
CharacterAddSkill(_Player, "Projectile_Bullethell");
CharacterAddSkill(_Player, "Target_Musk_Steadfast");
CharacterAddSkill(_Player, "Projectile_LaunchTripwireFlare");
CharacterAddSkill(_Player, "Projectile_Tracking_Shot");
CharacterAddSkill(_Player, "Projectile_Final_Act");
CharacterLevelUpTo(_Player, 10);
SetTag(_Player, "Rifle_Armed");
DB_Musketeer_RifleEquipped(_Player, 1);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Player);
*/
IF
SkillAdded(_Player, "Shout_Musketeer_Passive", 0)
AND
CharacterGetEquippedWeapon(_Player, _Weapon)
THEN
SetTag(_Player, "Rifle_Armed");
CharacterAddSkill(_Player, "Shout_Reload");
DB_Musketeer_RifleEquipped(_Player, 1);
NRD_AmmoBar_Set_GUI(_Player, "val", 1);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Player);
Musketeer_Rifle_Range_Tags((ITEMGUID)_Weapon, _Player);
CharacterAddSkill(_Player, "Shout_Reload_Incendiary");
CharacterAddSkill(_Player, "Shout_Reload_Explosive");
CharacterAddSkill(_Player, "Shout_Reload_Freezing");
CharacterAddSkill(_Player, "Shout_Reload_Silver");
CharacterAddSkill(_Player, "Shout_Reload_Holy");
//CharacterAddAbility(_Player, "Repair", 5);
//ApplyStatus(_Player, "MUSK_RANGE_10", -1.0, 1, _Player);
//Musketeer_Rifle_Range_Tags((ITEMGUID)_Weapon, (CHARACTERGUID)_Player);
//NRD_EXT_TestLog("Hello there!");
//Musketeer_Open_TestWindow();


// DEPRECATED
// No longer needed. Same functionality implemented in Lua.
/*
IF
DB_Musketeer_ModStarted(1)
AND
DB_Musketeer_Skillist(_SkillName, _AmmoCost)
AND
NOT _AmmoCost == 0
THEN
NRD_Broadcast_Rifle_Skill("val", (STRING)_SkillName, (INTEGER)_AmmoCost);
*/

PROC
Musketeer_Send_Ammo_Count((CHARACTERGUID)_Player, (ITEMGUID)_Weapon)
AND
ItemGetCharges(_Weapon, _Ammo)
AND
ItemGetMaxCharges(_Weapon, _MaxAmmo)
THEN
NRD_AmmoBar_Set_Ammo(_Player, "val",_Ammo);
NRD_AmmoBar_Set_Max_Ammo(_Player, "val", _MaxAmmo);

// Trigger dynamic range check on level up, as that might cause the range to reset.
IF
CharacterLeveledUp(_Player)
AND
CharacterIsPlayer(_Player, 1)
AND
CharacterHasSkill(_Player, "Shout_Musketeer_Passive", 1)
AND
CharacterGetEquippedWeapon(_Player, _Weapon)
THEN
Musketeer_Rifle_Range_Tags((ITEMGUID)_Weapon, _Player);



// When a player no longer has the Passive-Skill, then we know he doesn't have a rifle equipped anymore.
// We clear all rifle-tags, otherwise they would persist when equipping another rifle.
IF
SkillDeactivated(_Player, "Shout_Musketeer_Passive")
AND
CharacterHasSkill(_Player, "Shout_Musketeer_Passive", 0)
THEN
//DisplayText(_Player, "<font color='#00FF00' size='30'>No longer pew pew ready</font>");
//CharacterRemoveSkill(_Player, "Shout_Reload");
DB_Musketeer_RifleEquipped(_Player, 0);
ClearTag(_Player, "Rifle_Armed");
ClearTag(_Player, "Musketeer_None_Left");
ClearTag(_Player, "Musketeer_AtLeast_One_Left");
ClearTag(_Player, "Musketeer_AtLeast_Two_Left");
RemoveStatus(_Player, "MUSK_RANGE_10");
RemoveStatus(_Player, "MUSK_RANGE_6");
RemoveStatus(_Player, "MUSK_RANGE_8");
RemoveStatus(_Player, "MUSK_RANGE_10_NEG");
RemoveStatus(_Player, "MUSK_RANGE_6_NEG");
RemoveStatus(_Player, "MUSK_RANGE_8_NEG");
NRD_AmmoBar_Set_GUI(_Player, "val", 0);
//RemoveStatus(_Player, "MUSK_RANGE_10");
//CharacterRemoveAbility(_Player, "Repair", 5);





// Auto-Reload weapon before combat begins.
// QoL, seems tedious that a player has to remember to reload before every fight.
IF
CombatStarted(_Combat)
AND
DB_IsPlayer(_Character)
AND
CharacterIsInCombat(_Character, 1)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);

// Consume item charges when player uses a Rifle-Skill
IF
//CharacterUsedSkill(_Character, _Skill, _, _)
SKillCast(_Character, _Skill, _, _)
AND
DB_Musketeer_Skillist(_Skill, _Amount)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
Musketeer_Consume_Ammo((ITEMGUID)_Weapon, (INTEGER)_Amount, _Character);
Musketeer_Update_Ammo_Skills(_Character);


// Auto-Attacking also consumes Ammo. A player should not be able to basic attack when out of ammo.

// If Character has no ammo left, he cannot basic attack.
IF
CharacterStartAttackObject(_, _, _Character)
AND
IsTagged(_Character, "Musketeer_None_Left", 1)
AND
DB_IsPlayer(_Character)
THEN
//ApplyStatus(_Character, "DISARMED", 0.0);
CharacterUseSkill(_Character, "Target_Unload_Buffer", _Character);
CharacterAddActionPoints(_Character, 2);
//DisplayText(_Character, "<font color='#00FF00' size='30'>Out of Ammo!</font>");


IF
CharacterStartAttackPosition(_, _, _, _, _Character)
AND
IsTagged(_Character, "Musketeer_None_Left", 1)
AND
DB_IsPlayer(_Character)
AND
CharacterGetEquippedWeapon(_Character, _Weapon)
THEN
CharacterUseSkill(_Character, "Target_Unload_Buffer", _Character);
CharacterAddActionPoints(_Character, 2);
Musketeer_Consume_Ammo((ITEMGUID)_Weapon, 1, _Character);
//DisplayText(_Character, "<font color='#00FF00' size='30'>Out of Ammo!</font>");


// Consume 1 Ammo when Character uses basic attack.
IF
CharacterStartAttackObject(_, _, _Character)
AND
IsTagged(_Character, "Musketeer_None_Left", 0)
AND
IsTagged(_Character, "Musketeer_AtLeast_One_Left", 1)
AND
DB_IsPlayer(_Character)
//AND
//CharacterIsInCombat(_Character, 0)
AND
CharacterGetEquippedWeapon(_Character, _Weapon)
THEN
//ApplyStatus(_Character, "DISARMED", 0.0);
Musketeer_Consume_Ammo((ITEMGUID)_Weapon, -1, _Character);
//DisplayText(_Character, "<font color='#00FF00' size='30'>Out of Ammo!</font>");


IF
CharacterStartAttackPosition(_, _, _, _, _Character)
AND
IsTagged(_Character, "Musketeer_None_Left", 0)
AND
IsTagged(_Character, "Musketeer_AtLeast_One_Left", 1)
AND
DB_IsPlayer(_Character)
//AND
//CharacterIsInCombat(_Character, 0)
AND
CharacterGetEquippedWeapon(_Character, _Weapon)
THEN
Musketeer_Consume_Ammo((ITEMGUID)_Weapon, -1, _Character);


PROC 
Musketeer_Update_Ammo_Skills((CHARACTERGUID)_Player)
AND
DB_IsPlayer(_Player)
THEN
//DisplayText(_Player, "<font color='#00FF00' size='30'>Updating Ammo related stuff..</font>");
//Deactivate
DebugBreak("[WT_FS] Ammo Update PROC.");


//REGION Musketeer_Ammo_Management

// Use this PROC to consume the specified amount of charges when a Ammunition consuming Skill is used.
PROC
Musketeer_Consume_Ammo((ITEMGUID)_Weapon, (INTEGER)_Amount, (CHARACTERGUID)_Character)
THEN
ItemAddCharges(_Weapon, _Amount);
Musketeer_Ammo_Requirement_Tags(_Weapon, _Character);
//ApplyStatus(_Character, "CLEAR_MINDED", 0.0, 1, _Character);
// Apply a empty status to force a skillbar tag-requirement refresh.
//ApplyStatus(_Character, "MUSK_NULL_STATUS", 0.0, 1, _Character);


// The following PROCs handle the Ammunition tagging.
// the "MUSK_NULL_STATUS" grants +1 to "Repair" and forces a UI refresh.
// Without that, tag requirements are not updated on the skills.

PROC
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, (CHARACTERGUID)_Character)
AND
ItemGetCharges(_Weapon, _RemainingAmmo)
AND
_RemainingAmmo <= 0
THEN
SetTag(_Character, "Musketeer_None_Left");
ClearTag(_Character, "Musketeer_AtLeast_One_Left");
ClearTag(_Character, "Musketeer_AtLeast_Two_Left");
ClearTag(_Character, "Musketeer_Exactly_One_Left");
//ApplyStatus(_Character, "DISARMED", -1.0, 1, _Character);
DebugBreak("[WT_FS] No Ammo left.");
ApplyStatus(_Character, "MUSK_NULL_STATUS", 0.0, 1, _Character);

// When exactly 1 Ammo remaining, set armed, Atleast one and clear Atleast two.
PROC
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, (CHARACTERGUID)_Character)
AND
ItemGetCharges(_Weapon, _RemainingAmmo)
AND
_RemainingAmmo == 1
THEN
SetTag(_Character, "Musketeer_Exactly_One_Left");
SetTag(_Character, "Musketeer_AtLeast_One_Left");
ClearTag(_Character, "Musketeer_AtLeast_Two_Left");
//RemoveStatus(_Character, "DISARMED");
ClearTag(_Character, "Musketeer_None_Left");
DebugBreak("[WT_FS] Exactly 1 round left.");
ApplyStatus(_Character, "MUSK_NULL_STATUS", 0.0, 1, _Character);

// When at least 2 Ammo remaining, set armed, Atleast one, Atleast two.
PROC
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, (CHARACTERGUID)_Character)
AND
ItemGetCharges(_Weapon, _RemainingAmmo)
AND
_RemainingAmmo >= 2
THEN
SetTag(_Character, "Musketeer_AtLeast_Two_Left");
SetTag(_Character, "Musketeer_AtLeast_One_Left");
//RemoveStatus(_Character, "DISARMED");
ClearTag(_Character, "Musketeer_None_Left");
ClearTag(_Character, "Musketeer_Exactly_One_Left");
DebugBreak("[WT_FS] At least 2 rounds left.");
ApplyStatus(_Character, "MUSK_NULL_STATUS", 0.0, 1, _Character);

// Send Ammo Update event for client-side AmmoBar
PROC
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, (CHARACTERGUID)_Character)
THEN
Musketeer_Send_Ammo_Count(_Character, _Weapon);

//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Musketeer_Mod"
