Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION

// Special case when using Reload, as it restores the charges completely, and not by a fixed amount.
// Turns out, the skillbar doesn't update after updating/clearing tags.
// As it applies Statuses that cause a UI refresh, it's not a problem.
IF
CharacterUsedSkill(_Character, "Shout_Reload", _, _)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
//ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Update_Ammo_Skills(_Character);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);
//SetTag(_Character, "Musketeer_Reloading_State");
// I don't dislike this effect, so the whole UI refresh is not a big deal.

IF
CharacterUsedSkill(_Character, "Shout_Reload_Incendiary", _, _)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
//ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Update_Ammo_Skills(_Character);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);
//ApplyStatus(_Character, "RELOAD_INCENDIARY", 4.0, 1, _Character);

IF
CharacterUsedSkill(_Character, "Shout_Reload_Explosive", _, _)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
//ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Update_Ammo_Skills(_Character);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);
//ApplyStatus(_Character, "RELOAD_INCENDIARY", 4.0, 1, _Character);

IF
CharacterUsedSkill(_Character, "Shout_Reload_Freezing", _, _)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
//ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Update_Ammo_Skills(_Character);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);
//ApplyStatus(_Character, "RELOAD_INCENDIARY", 4.0, 1, _Character);

IF
CharacterUsedSkill(_Character, "Shout_Reload_Silver", _, _)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
//ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Update_Ammo_Skills(_Character);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);
//ApplyStatus(_Character, "RELOAD_INCENDIARY", 4.0, 1, _Character);

IF
CharacterUsedSkill(_Character, "Shout_Reload_Holy", _, _)
AND
DB_IsPlayer(_Character)
AND
DB_Musketeer_RifleEquipped(_Character, 1)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
THEN
//ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Update_Ammo_Skills(_Character);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);

//ApplyStatus(_Character, "RELOAD_INCENDIARY", 4.0, 1, _Character);


IF
//ObjectWasTagged(_Character, "Musketeer_Reloading_State")
CharacterStatusApplied(_Character, "RELOAD_DEBUFF", _)
THEN
ApplyStatus(_Character, "MUTED", -1.0, 1, _Character);
ApplyStatus(_Character, "DISARMED", -1.0, 1, _Character);

IF
//ObjectLostTag(_Character, "Musketeer_Reloading_State")
CharacterStatusRemoved(_Character, "RELOAD_DEBUFF", _)
AND
CharacterGetEquippedItem(_Character, "Weapon" ,_Weapon)
AND
IsTagged(_Character, "Rifle_Armed", 1)
THEN
RemoveStatus(_Character, "MUTED");
RemoveStatus(_Character, "DISARMED");
ItemResetChargesToMax((ITEMGUID)_Weapon);
Musketeer_Ammo_Requirement_Tags((ITEMGUID)_Weapon, _Character);

// Make the Mute and Disarmed Status uncleansable by reapplying them when removed, if the character has the
// Reload debuff.
IF
CharacterStatusRemoved(_Character, "MUTED", _)
AND
HasAppliedStatus(_Character, "RELOAD_DEBUFF", 1)
THEN
ApplyStatus(_Character, "MUTED", -1.0, 1, _Character);

IF
CharacterStatusRemoved(_Character, "DISARMED", _)
AND
HasAppliedStatus(_Character, "RELOAD_DEBUFF", 1)
THEN
ApplyStatus(_Character, "DISARMED", -1.0, 1, _Character);


EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Musketeer_Mod"
